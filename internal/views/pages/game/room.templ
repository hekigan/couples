package game

import (
	"fmt"
	"github.com/google/uuid"
	"github.com/hekigan/couples/internal/models"
	"github.com/hekigan/couples/internal/viewmodels"
	"github.com/hekigan/couples/internal/views/layouts"
)

// RoomPage renders the room lobby page with layout
templ RoomPage(data *viewmodels.TemplateData) {
	@layouts.Base(data, RoomContent(data))
}

// RoomContent renders the room lobby content with SSE integration
templ RoomContent(data *viewmodels.TemplateData) {
	if room, ok := data.Data.(*models.Room); ok {
		<div
			class="room-container"
			data-room-id={ room.ID.String() }
			data-is-owner={ fmt.Sprintf("%t", data.IsOwner) }
			data-selected-categories={ getSelectedCategoriesJSON(room.SelectedCategories) }
			hx-ext="sse"
			sse-connect={ fmt.Sprintf("/api/v1/stream/rooms/%s/events", room.ID.String()) }
		>
			<!-- Room Header -->
			if room.Status == "waiting" {
				<div class="room-header-section" data-testid="room-header">
					<div>
						<h1 data-testid="room-title">
							Room ID
							<span class="room-status">
								<span
									class={ fmt.Sprintf("status-badge status-%s", room.Status) }
									id="room-status-badge"
									data-testid="room-status-badge"
									sse-swap="room_status_update"
									hx-swap="outerHTML"
								>
									if room.Status == "ready" {
										ready
									} else if room.Status == "playing" {
										playing
									} else {
										waiting
									}
								</span>
							</span>
						</h1>
						<form onsubmit="return false;">
							<fieldset role="group">
								<input
									type="text"
									id="room-id-input"
									value={ room.ID.String() }
									readonly
									class="room-id-input"
									data-testid="room-id-input"
								/>
								<button class="no-wrap" onclick="copyRoomId()" title="Copy Room ID" data-testid="copy-room-id-button">
									Copy
								</button>
							</fieldset>
							<small class="text-muted">Copy the room ID to share with friend</small>
						</form>
					</div>
				</div>
				<!-- Invite Friends Section (hidden when guest joined) - OWNER ONLY -->
				if data.IsOwner {
					<div class="invite-section" id="invite-section" style={ fmt.Sprintf("margin-top: 2rem; %s", templ.KV("display: none;", room.GuestID != nil)) }>
						<h2>ðŸ‘¥ Invite Friends</h2>
						<div
							id="friends-list"
							class="friends-list"
						>
							@templ.Raw(data.FriendsListHTML)
						</div>
					</div>
					<!-- Pending Join Requests Section (hidden when guest joined) - OWNER ONLY -->
					<div id="join-requests-section" style={ fmt.Sprintf("margin-top: 2rem; %s", templ.KV("display: none;", room.GuestID != nil)) }>
						<h2>
							ðŸ“¬ Join Requests
							<span id="request-count" class="badge" sse-swap="badge_update">{ fmt.Sprintf("%d", data.JoinRequestsCount) }</span>
						</h2>
						<!-- Join requests: initial load + SSE appends new ones (beforeend) -->
						<div id="join-requests" sse-swap="join_request" hx-swap="beforeend">
							@templ.Raw(data.JoinRequestsHTML)
						</div>
					</div>
				}
			}
			<!-- Players Section - Show only the other player -->
			<div class="room-players" id="player-list" data-testid="player-list">
				<div class="player-grid">
					<!-- Guest sees the Owner card -->
					if !data.IsOwner {
						<div class="player-card" data-player="owner" data-testid="owner-card">
							<span class="player-label">Owner</span>
							<span class="player-name" data-testid="owner-name">
								if data.OwnerUsername != "" {
									{ data.OwnerUsername }
								} else {
									Unknown
								}
							</span>
						</div>
					}
					<!-- Owner sees the Guest card - Updated via SSE when request accepted -->
					if data.IsOwner {
						<div
							class={ templ.KV("player-card", true), templ.KV("empty", room.GuestID == nil) }
							data-player="guest"
							id="guest-info"
							sse-swap="request_accepted"
							data-testid="guest-card"
						>
							<span class="player-label">Guest</span>
							if room.GuestID != nil {
								<span class="player-name" id="guest-name" data-testid="guest-name">
									if data.GuestUsername != "" {
										{ data.GuestUsername }
									} else {
										Unknown
									}
								</span>
							} else {
								<span class="player-name" id="guest-waiting" data-testid="guest-waiting">Waiting for guest...</span>
							}
						</div>
					}
				</div>
			</div>
			<!-- Category Selection Section (shown when guest joined) -->
			<div
				id="categories-section"
				data-testid="categories-section"
				style={ templ.KV("display: none;", room.GuestID == nil) }
			>
				<h2 data-testid="categories-heading">Select Question Categories</h2>
				<p class="categories-hint">Both players can select categories. Selections sync in real-time!</p>
				<div
					id="categories-grid"
					data-testid="categories-grid"
					sse-swap="categories_updated"
					hx-swap="innerHTML"
				>
					@templ.Raw(data.CategoriesGridHTML)
				</div>
			</div>
			<!-- Start Game Button (shown when ready) - OWNER ONLY -->
			if data.IsOwner {
				<div
					class="start-game-section"
					id="start-game-section"
					style={ templ.KV("display: none;", room.Status != "ready") }
					hx-get={ fmt.Sprintf("/api/v1/rooms/%s/start-button", room.ID.String()) }
					hx-trigger="load, sse:room_update from:body"
				>
					@templ.Raw(data.ActionButtonHTML)
				</div>
			}
			<!-- Ready Button - GUEST ONLY -->
			if !data.IsOwner {
				if room.Status == "ready" {
					<div
						class="guest-ready-section"
						id="guest-ready-section"
					>
						@templ.Raw(data.ActionButtonHTML)
					</div>
				}
			}
			<!-- Owner Actions (Delete Room) - OWNER ONLY -->
			if data.IsOwner {
				<div class="room-actions" data-testid="room-actions">
					<form action={ templ.URL(fmt.Sprintf("/game/room/%s/delete", room.ID.String())) } method="POST" onsubmit="return confirm('Delete this room?');">
						if data.CSRFToken != "" {
							<input type="hidden" name="csrf" value={ data.CSRFToken }/>
						}
						<button type="submit" class="contrast" data-testid="delete-room-button">Delete Room</button>
					</form>
				</div>
			}
			<!-- Game Started redirect - Hidden element that receives SSE redirect fragment -->
			<div id="game-start-redirect" sse-swap="game_started" style="display:none;"></div>
		</div>
		@RoomScript()
	}
}

// RoomScript contains the JavaScript for the room page
templ RoomScript() {
	<script>
		// ============================================================================
		// MINIMAL JAVASCRIPT - Only for non-SSE features
		// ============================================================================
		// This is dramatically reduced from 800+ lines to ~200 lines
		// All SSE event handling is now done by HTMX

		// Copy room ID to clipboard
		function copyRoomId() {
			const input = document.getElementById('room-id-input');
			input.select();
			document.execCommand('copy');

			const btn = event.target;
			const originalText = btn.textContent;
			btn.textContent = 'âœ… Copied!';
			btn.style.background = '#10b981';

			setTimeout(() => {
				btn.textContent = originalText;
				btn.style.background = '';
			}, 2000);
		}

		// Load page state on DOM ready
		document.addEventListener('DOMContentLoaded', async () => {
			const container = document.querySelector('.room-container');
			const roomId = container?.dataset.roomId || '';
			const isOwner = container?.dataset.isOwner === 'true';

			console.log('ðŸ” Room ID:', roomId, 'IsOwner:', isOwner);

			// Fetch fresh state from database to fix race conditions
			try {
				console.log('ðŸ“¡ Fetching fresh room state...');
				const response = await fetch(`/api/v1/stream/rooms/${roomId}/state`);
				if (response.ok) {
					const state = await response.json();
					console.log('ðŸ“Š Fresh state loaded:', state);

					// If game already started, redirect
					if (state.status === 'playing') {
						console.log('ðŸŽ® Game already started, redirecting...');
						window.location.href = `/game/play/${roomId}`;
						return;
					}
				}
			} catch (error) {
				console.error('âŒ Failed to load initial state:', error);
			}

			console.log('âœ… HTMX SSE connection established via hx-ext="sse"');
			console.log('âœ… Phase A: Friends & Categories loading via HTMX hx-get');
		});

		// ============================================================================
		// HTMX now handles:
		// - Friends list loading via hx-get="/api/v1/friends/list-html"
		// - Categories loading via hx-get="/api/v1/rooms/{id}/categories"
		// - Category toggle via hx-post in template (optimistic UI)
		// - Friend invitation via hx-post in template (server-rendered state transitions)
		// ============================================================================

		// ============================================================================
		// HTMX now handles:
		// - Guest ready button via hx-post="/api/v1/rooms/{id}/guest-ready"
		// - Start game button via hx-post="/api/v1/rooms/{id}/start"
		// - Category validation via hx-on::before-request in templates
		// - Button state syncing via SSE (room_update event)
		// ============================================================================

		// ============================================================================
		// UI Utilities
		// ============================================================================
		function showNotification(message, type) {
			const notification = document.createElement('div');
			notification.className = `notification notification-${type}`;
			notification.textContent = message;
			notification.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				padding: 1rem 1.5rem;
				background: ${type === 'success' ? '#10b981' : '#ef4444'};
				color: white;
				border-radius: 8px;
				box-shadow: 0 4px 6px rgba(0,0,0,0.1);
				z-index: 10000;
				animation: slideIn 0.3s ease-out;
			`;

			document.body.appendChild(notification);

			setTimeout(() => {
				notification.style.animation = 'slideOut 0.3s ease-out';
				setTimeout(() => notification.remove(), 300);
			}, 3000);
		}

		// ============================================================================
		// HTMX will handle all SSE events automatically:
		// - join_request â†’ appends to #join-requests
		// - request_accepted â†’ replaces #guest-info
		// - categories_updated â†’ updates #categories-section
		// - game_started â†’ updates #game-start-redirect (triggers redirect)
		// - room_update â†’ handled by backend HTML fragments
		// ============================================================================
		console.log('âœ… HTMX SSE mode active - ~80% less JavaScript than original!');
	</script>
}

// Helper function to convert selected categories to JSON string
func getSelectedCategoriesJSON(categories []uuid.UUID) string {
	if len(categories) == 0 {
		return ""
	}
	result := ""
	for i, cat := range categories {
		if i > 0 {
			result += ","
		}
		result += fmt.Sprintf("\"%s\"", cat.String())
	}
	return result
}
