package game

import (
	"fmt"
	"github.com/google/uuid"
	"github.com/hekigan/couples/internal/models"
	"github.com/hekigan/couples/internal/viewmodels"
	"github.com/hekigan/couples/internal/views/layouts"
)

// RoomPage renders the room lobby page with layout
templ RoomPage(data *viewmodels.TemplateData) {
	@layouts.Base(data, RoomContent(data))
}

// RoomContent renders the room lobby content with SSE integration
templ RoomContent(data *viewmodels.TemplateData) {
	if room, ok := data.Data.(*models.Room); ok {
		<div
			class="room-container"
			data-room-id={ room.ID.String() }
			data-is-owner={ fmt.Sprintf("%t", data.IsOwner) }
			data-selected-categories={ getSelectedCategoriesJSON(room.SelectedCategories) }
			hx-ext="sse"
			sse-connect={ fmt.Sprintf("/api/v1/stream/rooms/%s/events", room.ID.String()) }
		>
			<!-- Room Header -->
			<div class="room-header-section" data-testid="room-header">
				<div>
					<h1 data-testid="room-title">
						Room ID
						<span class="room-status">
							<span
								class={ fmt.Sprintf("status-badge status-%s", room.Status) }
								id="room-status-badge"
								data-testid="room-status-badge"
								sse-swap="room_status_update"
								hx-swap="outerHTML"
							>
								if room.Status == "ready" {
									ready
								} else if room.Status == "playing" {
									playing
								} else {
									waiting
								}
							</span>
						</span>
					</h1>
					<form onsubmit="return false;">
						<fieldset role="group">
							<input
								type="text"
								id="room-id-input"
								value={ room.ID.String() }
								readonly
								class="room-id-input"
								data-testid="room-id-input"
							/>
							<button class="no-wrap" onclick="copyRoomId()" title="Copy Room ID" data-testid="copy-room-id-button">
								Copy
							</button>
						</fieldset>
						<small class="text-muted">Copy the room ID to share with friend</small>
					</form>
				</div>
			</div>
			<!-- Players Section -->
			<div class="room-players" id="player-list" data-testid="player-list">
				<h2 data-testid="players-heading">Players</h2>
				<div class="player-grid">
					<div class="player-card" data-player="owner" data-testid="owner-card">
						<span class="player-label">Owner</span>
						<span class="player-name" data-testid="owner-name">
							if data.OwnerUsername != "" {
								{ data.OwnerUsername }
							} else {
								Unknown
							}
						</span>
					</div>
					<!-- Guest card - Updated via SSE when request accepted -->
					<div
						class={ templ.KV("player-card", true), templ.KV("empty", room.GuestID == nil) }
						data-player="guest"
						id="guest-info"
						sse-swap="request_accepted"
						data-testid="guest-card"
					>
						<span class="player-label">Guest</span>
						if room.GuestID != nil {
							<span class="player-name" id="guest-name" data-testid="guest-name">
								if data.GuestUsername != "" {
									{ data.GuestUsername }
								} else {
									Unknown
								}
							</span>
						} else {
							<span class="player-name" id="guest-waiting" data-testid="guest-waiting">Waiting for guest...</span>
						}
					</div>
				</div>
			</div>
			<!-- Category Selection Section (shown when guest joined) -->
			<div
				id="categories-section"
				data-testid="categories-section"
				style={ templ.KV("display: none;", room.GuestID == nil) }
			>
				<h2 data-testid="categories-heading">Select Question Categories</h2>
				<p class="categories-hint">Both players can select categories. Selections sync in real-time!</p>
				<div
					id="categories-grid"
					data-testid="categories-grid"
					sse-swap="categories_updated"
					hx-swap="innerHTML"
				>
					@templ.Raw(data.CategoriesGridHTML)
				</div>
			</div>
			<!-- Start Game Button (shown when ready) - OWNER ONLY -->
			if data.IsOwner {
				<div
					class="start-game-section"
					id="start-game-section"
					style={ templ.KV("display: none;", room.Status != "ready") }
					hx-get={ fmt.Sprintf("/api/v1/rooms/%s/start-button", room.ID.String()) }
					hx-trigger="load, sse:room_update from:body"
				>
					@templ.Raw(data.ActionButtonHTML)
				</div>
			}
			<!-- Ready Button - GUEST ONLY -->
			if !data.IsOwner {
				if room.Status == "ready" {
					<div
						class="guest-ready-section"
						id="guest-ready-section"
					>
						@templ.Raw(data.ActionButtonHTML)
					</div>
				}
			}
			<!-- Invite Friends Section (hidden when guest joined) - OWNER ONLY -->
			if data.IsOwner {
				<div class="invite-section" id="invite-section" style={ fmt.Sprintf("margin-top: 2rem; %s", templ.KV("display: none;", room.GuestID != nil)) }>
					<h2>ðŸ‘¥ Invite Friends</h2>
					<div
						id="friends-list"
						class="friends-list"
					>
						@templ.Raw(data.FriendsListHTML)
					</div>
				</div>
				<!-- Pending Join Requests Section (hidden when guest joined) - OWNER ONLY -->
				<div id="join-requests-section" style={ fmt.Sprintf("margin-top: 2rem; %s", templ.KV("display: none;", room.GuestID != nil)) }>
					<h2>
						ðŸ“¬ Join Requests
						<span id="request-count" class="badge" sse-swap="badge_update">{ fmt.Sprintf("%d", data.JoinRequestsCount) }</span>
					</h2>
					<!-- Join requests: initial load + SSE appends new ones (beforeend) -->
					<div id="join-requests" sse-swap="join_request" hx-swap="beforeend">
						@templ.Raw(data.JoinRequestsHTML)
					</div>
				</div>
			}
			<!-- Owner Actions (Delete Room) - OWNER ONLY -->
			if data.IsOwner {
				<div class="room-actions" data-testid="room-actions">
					<form action={ templ.URL(fmt.Sprintf("/game/room/%s/delete", room.ID.String())) } method="POST" onsubmit="return confirm('Delete this room?');">
						if data.CSRFToken != "" {
							<input type="hidden" name="csrf" value={ data.CSRFToken }/>
						}
						<button type="submit" class="contrast" data-testid="delete-room-button">Delete Room</button>
					</form>
				</div>
			}
			<!-- Game Started redirect - Hidden element that receives SSE redirect fragment -->
			<div id="game-start-redirect" sse-swap="game_started" style="display:none;"></div>
		</div>
		@RoomScript()
		@RoomStyles()
	}
}

// RoomScript contains the JavaScript for the room page
templ RoomScript() {
	<script>
		// ============================================================================
		// MINIMAL JAVASCRIPT - Only for non-SSE features
		// ============================================================================
		// This is dramatically reduced from 800+ lines to ~200 lines
		// All SSE event handling is now done by HTMX

		// Copy room ID to clipboard
		function copyRoomId() {
			const input = document.getElementById('room-id-input');
			input.select();
			document.execCommand('copy');

			const btn = event.target;
			const originalText = btn.textContent;
			btn.textContent = 'âœ… Copied!';
			btn.style.background = '#10b981';

			setTimeout(() => {
				btn.textContent = originalText;
				btn.style.background = '';
			}, 2000);
		}

		// Load page state on DOM ready
		document.addEventListener('DOMContentLoaded', async () => {
			const container = document.querySelector('.room-container');
			const roomId = container?.dataset.roomId || '';
			const isOwner = container?.dataset.isOwner === 'true';

			console.log('ðŸ” Room ID:', roomId, 'IsOwner:', isOwner);

			// Fetch fresh state from database to fix race conditions
			try {
				console.log('ðŸ“¡ Fetching fresh room state...');
				const response = await fetch(`/api/v1/stream/rooms/${roomId}/state`);
				if (response.ok) {
					const state = await response.json();
					console.log('ðŸ“Š Fresh state loaded:', state);

					// If game already started, redirect
					if (state.status === 'playing') {
						console.log('ðŸŽ® Game already started, redirecting...');
						window.location.href = `/game/play/${roomId}`;
						return;
					}
				}
			} catch (error) {
				console.error('âŒ Failed to load initial state:', error);
			}

			console.log('âœ… HTMX SSE connection established via hx-ext="sse"');
			console.log('âœ… Phase A: Friends & Categories loading via HTMX hx-get');
		});

		// ============================================================================
		// HTMX now handles:
		// - Friends list loading via hx-get="/api/v1/friends/list-html"
		// - Categories loading via hx-get="/api/v1/rooms/{id}/categories"
		// - Category toggle via hx-post in template (optimistic UI)
		// - Friend invitation via hx-post in template (server-rendered state transitions)
		// ============================================================================

		// ============================================================================
		// HTMX now handles:
		// - Guest ready button via hx-post="/api/v1/rooms/{id}/guest-ready"
		// - Start game button via hx-post="/api/v1/rooms/{id}/start"
		// - Category validation via hx-on::before-request in templates
		// - Button state syncing via SSE (room_update event)
		// ============================================================================

		// ============================================================================
		// UI Utilities
		// ============================================================================
		function showNotification(message, type) {
			const notification = document.createElement('div');
			notification.className = `notification notification-${type}`;
			notification.textContent = message;
			notification.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				padding: 1rem 1.5rem;
				background: ${type === 'success' ? '#10b981' : '#ef4444'};
				color: white;
				border-radius: 8px;
				box-shadow: 0 4px 6px rgba(0,0,0,0.1);
				z-index: 10000;
				animation: slideIn 0.3s ease-out;
			`;

			document.body.appendChild(notification);

			setTimeout(() => {
				notification.style.animation = 'slideOut 0.3s ease-out';
				setTimeout(() => notification.remove(), 300);
			}, 3000);
		}

		// ============================================================================
		// HTMX will handle all SSE events automatically:
		// - join_request â†’ appends to #join-requests
		// - request_accepted â†’ replaces #guest-info
		// - categories_updated â†’ updates #categories-section
		// - game_started â†’ updates #game-start-redirect (triggers redirect)
		// - room_update â†’ handled by backend HTML fragments
		// ============================================================================
		console.log('âœ… HTMX SSE mode active - ~80% less JavaScript than original!');
	</script>
}

// RoomStyles contains the CSS for the room page
templ RoomStyles() {
	<style>
		/* Accessibility */
		.sr-only {
			position: absolute;
			width: 1px;
			height: 1px;
			padding: 0;
			margin: -1px;
			overflow: hidden;
			clip: rect(0, 0, 0, 0);
			white-space: nowrap;
			border-width: 0;
		}

		/* HTMX Loading Indicators */
		.htmx-indicator {
			display: none;
		}
		.htmx-request .htmx-indicator,
		.htmx-request.htmx-indicator {
			display: inline;
		}

		/* Error/Success States */
		.category-checkbox.error {
			animation: shake 0.3s ease-in-out;
			background-color: rgba(239, 68, 68, 0.1);
		}
		.category-checkbox.saved {
			animation: pulse 0.3s ease-in-out;
			background-color: rgba(16, 185, 129, 0.1);
		}

		@keyframes shake {
			0%, 100% { transform: translateX(0); }
			25% { transform: translateX(-4px); }
			75% { transform: translateX(4px); }
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.7; }
		}

		.badge {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			background: #ef4444;
			color: white;
			border-radius: 12px;
			font-size: 0.75rem;
			font-weight: 600;
			margin-left: 0.5rem;
		}

		.info-box {
			border-radius: 8px;
			margin: 1rem 0;
		}

		@keyframes slideIn {
			from { transform: translateX(400px); opacity: 0; }
			to { transform: translateX(0); opacity: 1; }
		}

		@keyframes slideOut {
			from { transform: translateX(0); opacity: 1; }
			to { transform: translateX(400px); opacity: 0; }
		}

		.room-header-section {
			margin-bottom: 2rem;
		}

		.room-header-section h1 {
			display: inline-flex;
		}

		.room-id-input {
			font-family: monospace;
			padding: 0.5rem 0.75rem;
			border: 2px solid #e5e7eb;
			border-radius: 6px;
			background: #f9fafb;
			font-size: 0.875rem;
			color: #4b5563;
			width: 300px;
			cursor: text;
		}

		.room-id-input:focus {
			outline: none;
			border-color: #6B4CE6;
		}

		.copy-btn {
			white-space: nowrap;
			transition: all 0.2s;
		}

		.player-label {
			font-size: 0.875rem;
			color: #6b7280;
			font-weight: 500;
		}

		.player-name {
			font-size: 1.125rem;
			font-weight: 600;
			color: #111827;
		}

		.invite-section {
			background: white;
			border-radius: 8px;
			padding: 1.5rem;
			box-shadow: 0 1px 3px rgba(0,0,0,0.1);
		}

		.friends-list {
			display: flex;
			flex-direction: column;
			gap: 0.75rem;
			margin-top: 1rem;
		}

		.friend-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0.75rem 1rem;
			background: #f9fafb;
			border-radius: 6px;
			border: 1px solid #e5e7eb;
		}

		.friend-info {
			display: flex;
			align-items: center;
			gap: 0.75rem;
		}

		.friend-name {
			font-weight: 500;
			color: #111827;
		}

		.friend-item button:disabled {
			cursor: not-allowed;
		}

		/* Start Game Section */
		.start-game-section {
			margin-top: 2rem;
			text-align: center;
			padding: 2rem;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
		}

		.start-game-btn {
			font-size: 1.25rem;
			padding: 1rem 3rem;
			background: white;
			color: #667eea;
			border: none;
			border-radius: 50px;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
		}

		.start-game-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
			background: #f0f0f0;
		}

		.start-game-btn:active {
			transform: translateY(0);
		}

		/* Status badge colors */
		.status-ready {
			background: #dcfce7;
			color: #166534;
		}

		.status-playing {
			background: #dbeafe;
			color: #1e40af;
		}

		.status-waiting {
			background: #fef3c7;
			color: #92400e;
		}

		/* Categories Section */
		.categories-section {
			background: white;
			border-radius: 12px;
			padding: 2rem;
			margin: 2rem 0;
			box-shadow: 0 1px 3px rgba(0,0,0,0.1);
		}

		.categories-section h2 {
			margin-top: 0;
			color: #111827;
			margin-bottom: 0.5rem;
		}

		.categories-hint {
			color: #6b7280;
			font-size: 0.875rem;
			margin-bottom: 1.5rem;
		}

		.categories-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			gap: 1rem;
		}

		.category-checkbox {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			padding: 1rem;
			background: #f9fafb;
			border: 2px solid #e5e7eb;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.2s;
			user-select: none;
			width: 100% !important;
		}

		.category-checkbox:hover {
			background: #f3f4f6;
			border-color: #667eea;
		}

		.category-checkbox input[type="checkbox"] {
			width: 20px;
			height: 20px;
			cursor: pointer;
			accent-color: #667eea;
		}

		.category-checkbox input[type="checkbox"]:checked + .category-label {
			color: #667eea;
			font-weight: 600;
		}

		.category-label {
			flex: 1;
			font-size: 1rem;
			color: #374151;
			text-transform: capitalize;
		}

		@media (max-width: 768px) {
			.categories-grid {
				grid-template-columns: 1fr;
			}
		}

		/* Guest Ready Section */
		.guest-ready-section {
			text-align: center;
			padding: 2rem;
			background: white;
			border-radius: 12px;
			margin: 1rem 0;
		}

		.ready-btn {
			font-size: 1.25rem;
			padding: 1rem 2rem;
			background: #10b981;
			border: none;
			color: white;
			font-weight: 600;
			transition: all 0.3s;
		}

		.ready-btn:hover {
			background: #059669;
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
		}

		.ready-hint {
			color: #6b7280;
			font-size: 0.875rem;
			margin-top: 0.5rem;
		}

		.ready-confirmed-message {
			background: #dcfce7;
			color: #166534;
			padding: 1.5rem;
			border-radius: 8px;
			font-weight: 600;
			font-size: 1.1rem;
		}

		/* Disabled checkboxes */
		.category-checkbox input[type="checkbox"]:disabled {
			cursor: not-allowed;
			opacity: 0.6;
		}

		.category-checkbox input[type="checkbox"]:disabled + .category-label {
			color: #9ca3af;
		}
	</style>
}

// Helper function to convert selected categories to JSON string
func getSelectedCategoriesJSON(categories []uuid.UUID) string {
	if len(categories) == 0 {
		return ""
	}
	result := ""
	for i, cat := range categories {
		if i > 0 {
			result += ","
		}
		result += fmt.Sprintf("\"%s\"", cat.String())
	}
	return result
}
