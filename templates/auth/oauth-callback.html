{{template "layout.html" .}}

{{define "content"}}
<div class="container" style="text-align: center; padding: 4rem 1rem;">
    <div class="card" style="max-width: 500px; margin: 0 auto;">
        <h2>Completing Login...</h2>
        <div class="loading-spinner" style="margin: 2rem auto;">
            <div class="spinner"></div>
        </div>
        <p>Please wait while we complete your authentication.</p>
    </div>
</div>

<script>
(function() {
    // Extract tokens from URL fragment
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const error = params.get('error');
    const errorDescription = params.get('error_description');
    
    if (error) {
        alert('Authentication error: ' + (errorDescription || error));
        window.location.href = '/auth/login';
        return;
    }
    
    if (accessToken) {
        // Send tokens to server
        fetch('/auth/oauth/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                access_token: accessToken,
                refresh_token: refreshToken
            })
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/';
            } else {
                throw new Error('Failed to process authentication');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to complete authentication. Please try again.');
            window.location.href = '/auth/login';
        });
    } else {
        // No token in fragment, might be PKCE flow with query params
        // Redirect to let server handle it
        window.location.href = window.location.pathname + window.location.search;
    }
})();
</script>

<style>
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
}

.spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top: 4px solid #6366f1;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{{end}}

