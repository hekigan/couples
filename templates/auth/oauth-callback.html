{{template "layout.html" .}}

{{define "content"}}
<div class="auth-callback-container">
    <article class="auth-callback-card">
        <header>
            <h2>Completing Login...</h2>
        </header>
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
        <p>Please wait while we complete your authentication.</p>
    </article>
</div>

<script>
(function() {
    // Extract tokens from URL fragment
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const error = params.get('error');
    const errorDescription = params.get('error_description');
    
    if (error) {
        alert('Authentication error: ' + (errorDescription || error));
        window.location.href = '/auth/login';
        return;
    }
    
    if (accessToken) {
        // Send tokens to server
        fetch('/auth/oauth/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                access_token: accessToken,
                refresh_token: refreshToken
            })
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/';
            } else {
                throw new Error('Failed to process authentication');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to complete authentication. Please try again.');
            window.location.href = '/auth/login';
        });
    } else {
        // No token in fragment, might be PKCE flow with query params
        // Redirect to let server handle it
        window.location.href = window.location.pathname + window.location.search;
    }
})();
</script>
{{end}}

