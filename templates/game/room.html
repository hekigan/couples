{{define "content"}}
<div class="room-container"
     data-room-id="{{.Data.ID}}"
     data-selected-categories='{{if .Data.SelectedCategories}}{{range $i, $cat := .Data.SelectedCategories}}{{if $i}},{{end}}"{{$cat}}"{{end}}{{end}}'
     hx-ext="sse"
     sse-connect="/api/rooms/{{.Data.ID}}/events">

    <div class="room-header-section" data-testid="room-header">
        <div>
            <h1 data-testid="room-title">
                Room ID

                <span class="room-status">
                    <span class="status-badge status-{{.Data.Status}}"
                          id="room-status-badge"
                          data-testid="room-status-badge"
                          sse-swap="room_status_update"
                          hx-swap="outerHTML">
                        {{if eq .Data.Status "ready"}}ready{{else if eq .Data.Status "playing"}}playing{{else}}waiting{{end}}
                    </span>
                </span>
            </h1>
            <form onsubmit="return false;">
                <fieldset role="group">
                    <input type="text" id="room-id-input" value="{{.Data.ID}}" readonly class="room-id-input" data-testid="room-id-input" />
                    <button class="no-wrap" onclick="copyRoomId()" title="Copy Room ID" data-testid="copy-room-id-button">
                        Copy
                    </button>
                </fieldset>
                <small class="text-muted">Copy the room ID to share with friends</small>
            </form>
        </div>
    </div>

    <div class="room-players" id="player-list" data-testid="player-list">
        <h2 data-testid="players-heading">Players</h2>
        <div class="player-grid">
            <div class="player-card" data-testid="owner-card">
                <span class="player-label">Owner</span>
                <span class="player-name" data-testid="owner-name">{{if .OwnerUsername}}{{.OwnerUsername}}{{else}}Unknown{{end}}</span>
            </div>
            <!-- Guest card - Updated via SSE when request accepted -->
            <div class="player-card {{if not .Data.GuestID}}empty{{end}}"
                 id="guest-info"
                 sse-swap="request_accepted"
                 data-testid="guest-card">
                {{if .Data.GuestID}}
                <span class="player-label">Guest</span>
                <span class="player-name" id="guest-name" data-testid="guest-name">{{if .GuestUsername}}{{.GuestUsername}}{{else}}Unknown{{end}}</span>
                {{else}}
                <span id="guest-waiting" data-testid="guest-waiting">Waiting for guest...</span>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Category Selection Section (shown when guest joined) -->
    <div id="categories-section"
         data-testid="categories-section"
         style="{{if not .Data.GuestID}}display: none;{{end}}">
        <h2 data-testid="categories-heading">Select Question Categories</h2>
        <p class="categories-hint">Both players can select categories. Selections sync in real-time!</p>

        <div id="categories-grid"
             data-testid="categories-grid"
             hx-get="/api/rooms/{{.Data.ID}}/categories"
             hx-trigger="load, sse:categories_updated from:body"
             hx-swap="innerHTML">
            <p class="loading-text">Loading categories...</p>
        </div>
    </div>

    <div>
        <!-- Start Game Button (shown when ready) - OWNER ONLY -->
        {{if .IsOwner}}
        <div class="start-game-section"
             id="start-game-section"
             style="{{if ne .Data.Status "ready"}}display: none;{{end}}"
             hx-get="/api/rooms/{{.Data.ID}}/start-button"
             hx-trigger="load, sse:room_update from:body"
             hx-swap="innerHTML">
            <p class="loading-text">Loading...</p>
        </div>
        {{end}}

        <!-- Ready Button - GUEST ONLY -->
        {{if not .IsOwner}}
        {{if eq .Data.Status "ready"}}
        <div class="guest-ready-section"
             id="guest-ready-section"
             hx-get="/api/rooms/{{.Data.ID}}/ready-button"
             hx-trigger="load"
             hx-swap="innerHTML">
            <p class="loading-text">Loading...</p>
        </div>
        {{end}}
        {{end}}
    </div>

    <!-- Invite Friends Section (hidden when guest joined) - OWNER ONLY -->
    {{if .IsOwner}}
    <div class="invite-section" id="invite-section" style="margin-top: 2rem; {{if .Data.GuestID}}display: none;{{end}}">
        <h2>ðŸ‘¥ Invite Friends</h2>
        <div id="friends-list"
             class="friends-list"
             hx-get="/api/friends/list-html?room_id={{.Data.ID}}"
             hx-trigger="load"
             hx-swap="innerHTML">
            <p class="loading-text">Loading friends...</p>
        </div>
    </div>

    <!-- Pending Join Requests Section (hidden when guest joined) - OWNER ONLY -->
    <div id="join-requests-section" style="margin-top: 2rem; {{if .Data.GuestID}}display: none;{{end}}">
        <h2>ðŸ“¬ Join Requests <span id="request-count" class="badge" sse-swap="badge_update">{{.JoinRequestsCount}}</span></h2>
        <!-- Join requests appended via SSE (beforeend appends to list) -->
        <div id="join-requests"
             sse-swap="join_request"
             hx-swap="beforeend">
        </div>
    </div>
    {{end}}

    <!-- Owner Actions (Delete Room) - OWNER ONLY -->
    {{if .IsOwner}}
    <div class="room-actions" data-testid="room-actions">
        <form action="/game/room/{{.Data.ID}}/delete" method="POST" onsubmit="return confirm('Delete this room?');">
            <button type="submit" class="contrast" data-testid="delete-room-button">Delete Room</button>
        </form>
    </div>
    {{end}}

    <!-- Game Started redirect - Hidden element that receives SSE redirect fragment -->
    <div id="game-start-redirect"
         sse-swap="game_started"
         style="display:none;">
    </div>
</div>

<script>
// ============================================================================
// MINIMAL JAVASCRIPT - Only for non-SSE features
// ============================================================================
// This is dramatically reduced from 800+ lines to ~200 lines
// All SSE event handling is now done by HTMX

// Copy room ID to clipboard
function copyRoomId() {
    const input = document.getElementById('room-id-input');
    input.select();
    document.execCommand('copy');

    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'âœ… Copied!';
    btn.style.background = '#10b981';

    setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
    }, 2000);
}

// Load page state on DOM ready
document.addEventListener('DOMContentLoaded', async () => {
    const roomId = document.querySelector('[data-room-id]').dataset.roomId;
    const isOwner = {{.IsOwner}};

    console.log('ðŸ” Room ID:', roomId, 'IsOwner:', isOwner);

    // Fetch fresh state from database to fix race conditions
    try {
        console.log('ðŸ“¡ Fetching fresh room state...');
        const response = await fetch(`/api/rooms/${roomId}/state`);
        if (response.ok) {
            const state = await response.json();
            console.log('ðŸ“Š Fresh state loaded:', state);

            // If game already started, redirect
            if (state.status === 'playing') {
                console.log('ðŸŽ® Game already started, redirecting...');
                window.location.href = `/game/play/${roomId}`;
                return;
            }
        }
    } catch (error) {
        console.error('âŒ Failed to load initial state:', error);
    }

    console.log('âœ… HTMX SSE connection established via hx-ext="sse"');
    console.log('âœ… Phase A: Friends & Categories loading via HTMX hx-get');
});

// ============================================================================
// HTMX now handles:
// - Friends list loading via hx-get="/api/friends/list-html"
// - Categories loading via hx-get="/api/rooms/{id}/categories"
// - Category toggle via hx-post in template (optimistic UI)
// - Friend invitation via hx-post in template (server-rendered state transitions)
// ============================================================================

// ============================================================================
// HTMX now handles:
// - Guest ready button via hx-post="/api/rooms/{id}/guest-ready"
// - Start game button via hx-post="/api/rooms/{id}/start"
// - Category validation via hx-on::before-request in templates
// - Button state syncing via SSE (room_update event)
// ============================================================================

// ============================================================================
// UI Utilities
// ============================================================================
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ============================================================================
// HTMX will handle all SSE events automatically:
// - join_request â†’ appends to #join-requests
// - request_accepted â†’ replaces #guest-info
// - categories_updated â†’ updates #categories-section
// - game_started â†’ updates #game-start-redirect (triggers redirect)
// - room_update â†’ handled by backend HTML fragments
// ============================================================================
console.log('âœ… HTMX SSE mode active - ~80% less JavaScript than original!');
</script>

<style>
/* Accessibility */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* HTMX Loading Indicators */
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator,
.htmx-request.htmx-indicator {
    display: inline;
}

/* Error/Success States */
.category-checkbox.error {
    animation: shake 0.3s ease-in-out;
    background-color: rgba(239, 68, 68, 0.1);
}
.category-checkbox.saved {
    animation: pulse 0.3s ease-in-out;
    background-color: rgba(16, 185, 129, 0.1);
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: #ef4444;
    color: white;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

.info-box {
    border-radius: 8px;
    margin: 1rem 0;
}

@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}

.room-header-section {
    margin-bottom: 2rem;
}

.room-header-section h1 {
    display: inline-flex;
}

.room-id-input {
    font-family: monospace;
    padding: 0.5rem 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    background: #f9fafb;
    font-size: 0.875rem;
    color: #4b5563;
    width: 300px;
    cursor: text;
}

.room-id-input:focus {
    outline: none;
    border-color: #6B4CE6;
}

.copy-btn {
    white-space: nowrap;
    transition: all 0.2s;
}

.player-card {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.player-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
}

.player-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
}

.invite-section {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.friends-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
}

.friend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f9fafb;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.friend-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.friend-name {
    font-weight: 500;
    color: #111827;
}

.friend-item button:disabled {
    cursor: not-allowed;
}

/* Start Game Section */
.start-game-section {
    margin-top: 2rem;
    text-align: center;
    padding: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.start-game-btn {
    font-size: 1.25rem;
    padding: 1rem 3rem;
    background: white;
    color: #667eea;
    border: none;
    border-radius: 50px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.start-game-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    background: #f0f0f0;
}

.start-game-btn:active {
    transform: translateY(0);
}

/* Status badge colors */
.status-ready {
    background: #dcfce7;
    color: #166534;
}

.status-playing {
    background: #dbeafe;
    color: #1e40af;
}

.status-waiting {
    background: #fef3c7;
    color: #92400e;
}

/* Categories Section */
.categories-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.categories-section h2 {
    margin-top: 0;
    color: #111827;
    margin-bottom: 0.5rem;
}

.categories-hint {
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
}

.categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.category-checkbox {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    width: 100% !important;
}

.category-checkbox:hover {
    background: #f3f4f6;
    border-color: #667eea;
}

.category-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #667eea;
}

.category-checkbox input[type="checkbox"]:checked + .category-label {
    color: #667eea;
    font-weight: 600;
}

.category-label {
    flex: 1;
    font-size: 1rem;
    color: #374151;
    text-transform: capitalize;
}

@media (max-width: 768px) {
    .categories-grid {
        grid-template-columns: 1fr;
    }
}

/* Guest Ready Section */
.guest-ready-section {
    text-align: center;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    margin: 1rem 0;
}

.ready-btn {
    font-size: 1.25rem;
    padding: 1rem 2rem;
    background: #10b981;
    border: none;
    color: white;
    font-weight: 600;
    transition: all 0.3s;
}

.ready-btn:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
}

.ready-hint {
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.ready-confirmed-message {
    background: #dcfce7;
    color: #166534;
    padding: 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1.1rem;
}

/* Disabled checkboxes */
.category-checkbox input[type="checkbox"]:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.category-checkbox input[type="checkbox"]:disabled + .category-label {
    color: #9ca3af;
}
</style>

{{end}}
