{{define "content"}}
<style>
    .game-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .game-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .game-progress {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }

    .turn-indicator {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
    }

    .turn-indicator.your-turn {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
    }

    .turn-indicator.waiting {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
    }

    .question-card {
        background: #fff;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 40px;
        margin: 20px 0;
        text-align: center;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .question-text {
        font-size: 20px;
        line-height: 1.6;
        color: #333;
    }

    .answer-form {
        margin-top: 30px;
    }

    .answer-form textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 16px;
        resize: vertical;
        min-height: 100px;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        flex: 1;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .answer-display {
        background: #e9ecef;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .answer-display h3 {
        margin-top: 0;
        color: #495057;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .typing-indicator {
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* HTMX Loading Indicators */
    .htmx-indicator {
        display: none;
        margin-left: 0.5rem;
    }

    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator {
        display: inline;
    }

    /* Accessibility */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
    }
</style>

<div class="game-container"
     data-room-id="{{.Data.Room.ID}}"
     hx-ext="sse"
     sse-connect="/api/rooms/{{.Data.Room.ID}}/events">

    <div class="game-header">
        <h1>{{.Data.Room.Name}}</h1>
        <div class="game-progress" id="progress">
            Question <span id="currentQuestion">{{.Data.Room.CurrentQuestion}}</span> of <span id="maxQuestions">{{.Data.Room.MaxQuestions}}</span>
        </div>
    </div>

    <div id="game-content"
         hx-get="/api/rooms/{{.Data.Room.ID}}/game-content"
         hx-trigger="load, sse:game_started, sse:room_update"
         hx-swap="innerHTML">
        <div class="loading">Loading game...</div>
    </div>
</div>

<script>
// Minimal JavaScript for SSE fallback and connection monitoring
(function() {
    const roomId = '{{.Data.Room.ID}}';

    // Listen for game_finished event to redirect
    document.body.addEventListener('sse:game_finished', function(e) {
        console.log('Game finished, redirecting...');
        setTimeout(() => {
            window.location.href = `/game/finished/${roomId}`;
        }, 500);
    });

    // Listen for room_update with finished status
    document.body.addEventListener('sse:room_update', function(e) {
        try {
            const data = JSON.parse(e.detail.data);
            if (data.status === 'finished') {
                console.log('Room finished, redirecting...');
                window.location.href = `/game/finished/${roomId}`;
            }
        } catch (error) {
            console.error('Error parsing room_update:', error);
        }
    });

    // Update progress counter when question is drawn
    document.body.addEventListener('sse:question_drawn', function(e) {
        try {
            const data = JSON.parse(e.detail.data);
            if (data.current_question !== undefined) {
                const currentQ = document.getElementById('currentQuestion');
                if (currentQ) {
                    currentQ.textContent = data.current_question;
                }
            }
        } catch (error) {
            console.error('Error updating progress:', error);
        }
    });

    // Handle typing status updates
    document.body.addEventListener('sse:player_typing', function(e) {
        try {
            const data = JSON.parse(e.detail.data);
            const currentUserId = '{{.Data.CurrentUserID}}';

            // Only show typing indicator if it's not the current user typing
            if (data.user_id !== currentUserId) {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.style.display = data.is_typing ? 'block' : 'none';
                }
            }
        } catch (error) {
            console.error('Error handling typing status:', error);
        }
    });

    console.log('ðŸŽ® Play page initialized with HTMX for room:', roomId);
})();
</script>
{{end}}
