{{define "content"}}
<style>
    .answer-form {
        margin-top: 30px;
    }

    .answer-form textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 16px;
        resize: vertical;
        min-height: 100px;
    }

    .answer-display {
        background: #e9ecef;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .answer-display h3 {
        margin-top: 0;
        color: #495057;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }

    .error {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .typing-indicator {
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* HTMX Loading Indicators */
    .htmx-indicator {
        display: none;
        margin-left: 0.5rem;
    }

    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator {
        display: inline;
    }

    /* Accessibility */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
    }
</style>

<div class="game-container"
     data-room-id="{{.Data.Room.ID}}"
     hx-ext="sse"
     sse-connect="/api/rooms/{{.Data.Room.ID}}/events"
     data-testid="game-container">

    <div class="game-header" data-testid="game-header">
        <div class="game-progress" id="progress" data-testid="game-progress">
            Question <span id="currentQuestion" data-testid="current-question">{{.Data.Room.CurrentQuestion}}</span> of <span id="maxQuestions" data-testid="max-questions">{{.Data.Room.MaxQuestions}}</span>
        </div>
        <!-- Turn Indicator - server-side rendered -->
        <div id="turn-indicator"
             hx-get="/api/rooms/{{.Data.Room.ID}}/turn-indicator"
             hx-trigger="sse:turn_changed from:body, sse:answer_submitted from:body"
             hx-swap="innerHTML">
            <div class="turn-indicator {{if .Data.IsMyTurn}}your-turn{{else}}waiting{{end}}" role="status" aria-live="polite">
                {{if .Data.IsMyTurn}}
                <span>‚ú® It's YOUR turn!</span>
                {{else}}
                <span>‚è≥ {{.Data.OtherPlayerName}} turn...</span>
                {{end}}
            </div>
        </div>
    </div>

    <div id="game-content" data-testid="game-content">

        <!-- Question Card - server-side rendered -->
        <div id="question-card"
             hx-get="/api/rooms/{{.Data.Room.ID}}/question-card"
             hx-trigger="sse:question_drawn from:body"
             hx-swap="innerHTML">
            <div class="question-card" role="region" aria-label="Current question">
                <p class="question-text">{{.Data.QuestionText}}</p>
            </div>
        </div>

        <!-- Game Forms - server-side rendered -->
        <div id="game-forms"
             hx-get="/api/rooms/{{.Data.Room.ID}}/game-forms"
             hx-trigger="sse:turn_changed from:body, sse:question_drawn from:body, sse:answer_submitted from:body, sse:player_typing from:body"
             hx-swap="innerHTML">
            {{if .Data.IsMyTurn}}
            <!-- Active player - show answer form -->
            <div class="answer-form">
                <form hx-post="/api/rooms/{{.Data.Room.ID}}/answer"
                      hx-target="#game-forms"
                      hx-swap="innerHTML"
                      hx-disabled-elt="button">
                    <input type="hidden" name="question_id" value="{{.Data.QuestionID}}">

                    <label for="answer-text" class="sr-only">Your answer (optional)</label>
                    <textarea id="answer-text"
                              name="answer_text"
                              placeholder="Write your answer here (optional)..."
                              rows="4"
                              aria-label="Your answer"></textarea>

                    <div class="button-group">
                        <button type="submit"
                                name="action_type"
                                value="answered"
                                class="btn btn-success">
                            ‚úÖ Answer
                        </button>
                        <button type="submit"
                                name="action_type"
                                value="passed"
                                class="btn btn-secondary">
                            ‚è≠Ô∏è Skip
                        </button>
                    </div>
                </form>
            </div>
            {{else}}
            <!-- Passive player - show waiting UI -->
            <div class="answer-display">
                <p>Waiting for {{.Data.OtherPlayerName}} to answer...</p>
            </div>
            {{end}}
        </div>

        <!-- Finish Game Button -->
        <div class="button-group" style="margin-top: 30px;">
            <button class="btn btn-danger"
                    hx-post="/api/rooms/{{.Data.Room.ID}}/finish"
                    hx-confirm="‚ö†Ô∏è Are you sure you want to finish the game?"
                    hx-disabled-elt="this"
                    aria-label="Finish game">
                End Game
            </button>
        </div>
    </div>
</div>

<script>
// Minimal JavaScript for SSE fallback and connection monitoring
(function() {
    const roomId = '{{.Data.Room.ID}}';

    // Listen for game_finished event to redirect
    document.body.addEventListener('sse:game_finished', function(e) {
        console.log('Game finished, redirecting...');
        setTimeout(() => {
            window.location.href = `/game/finished/${roomId}`;
        }, 500);
    });

    // Listen for room_update with finished status
    document.body.addEventListener('sse:room_update', function(e) {
        try {
            const data = JSON.parse(e.detail.data);
            if (data.status === 'finished') {
                console.log('Room finished, redirecting...');
                window.location.href = `/game/finished/${roomId}`;
            }
        } catch (error) {
            console.error('Error parsing room_update:', error);
        }
    });

    // Update progress counter when question is drawn
    document.body.addEventListener('sse:question_drawn', function(e) {
        try {
            const data = JSON.parse(e.detail.data);
            if (data.current_question !== undefined) {
                const currentQ = document.getElementById('currentQuestion');
                if (currentQ) {
                    currentQ.textContent = data.current_question;
                }
            }
        } catch (error) {
            console.error('Error updating progress:', error);
        }
    });

    // Handle typing status updates
    document.body.addEventListener('sse:player_typing', function(e) {
        try {
            const data = JSON.parse(e.detail.data);
            const currentUserId = '{{.Data.CurrentUserID}}';

            // Only show typing indicator if it's not the current user typing
            if (data.user_id !== currentUserId) {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.style.display = data.is_typing ? 'block' : 'none';
                }
            }
        } catch (error) {
            console.error('Error handling typing status:', error);
        }
    });

    console.log('üéÆ Play page initialized with HTMX for room:', roomId);
})();
</script>
{{end}}
